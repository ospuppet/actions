---
name: build vanagon project

inputs:
    directory:
        required: true
        type: string
    platform:
        required: true
        type: string
    project:
        required: true
        type: string

outputs:
    artifact-directory:
        value: ${{ inputs.directory }}/output

runs:
    using: composite
    steps:
        - name: generate cache key
          id: cachekey
          shell: bash
          working-directory: ${{ inputs.directory }}
          run: echo "value=$(bundle exec vanagon inspect ${{ inputs.project }} ${{ inputs.platform }} | jq -r '.[] | [.url, (.options | join(","))] | @csv' | md5sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT

        - uses: actions/cache@v4
          with:
              path: |-
                  workdir/*.gz
                  workdir/*.zip
                  workdir/*.xz
                  workdir/*.gem
              key: vanagon-sources-${{ steps.cachekey.outputs.value }}
              restore-keys: vanagon-sources-
              enableCrossOsArchive: true

        - name: build
          shell: bash
          run: |
              WHERE=$(pwd)
              mkdir -p workdir
              cd ${{ inputs.directory }}
              bundle exec vanagon build -e docker -k always -w "${WHERE}/workdir" -r "/tmp/${{ inputs.project }}" "${{ inputs.project }}" "${{ inputs.platform }}"
